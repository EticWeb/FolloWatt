#!/usr/bin/perl -w

# Lecture de l'historique envoyé par l'appareil "Current Cost" ou "BaroWatt" via cable USB et émulation de port série;
use strict;
use Device::SerialPort qw( :PARAM :STAT 0.07 );
use Date::Calc qw(Add_Delta_YMDHMS Today_and_Now);

my $PORT = "/dev/tty.usbserial";

my $ob = Device::SerialPort->new($PORT);
$ob->baudrate(57600);
$ob->write_settings;


open(SERIAL, "+>$PORT");
while (my $line = <SERIAL>) {
	print $line."\n\n";
	while ($line =~ m!<data><sensor>0</sensor>*(.+)</data><data><sensor>1</sensor>!g) {
		print $1."\n\n";
		my $subdata = $1;
		# Historique Horaire
		while ($subdata =~ m!<h(\d+)>*(.+)</h\1>!g) {
			my $sqlins = "";
			my ($year,$month,$day, $hour,$min,$sec) = Add_Delta_YMDHMS(Today_and_Now(), 0,0,0,-$1,0,0);# on retranche la valeur de la balise XML c a s le nb d'heure à la date actuelle
			my $strHeureMesure = sprintf("%4d-%02d-%02d %02d:%02d:%02d",$year,$month,$day,$hour,$min,$sec);
			#my $strHeureMesure = ($year+1900).'-'.($mon+1).'-'.$mday.' '.$hour.':'.$min.':'.$sec;
			$sqlins = 'insert into xmldataHH (date, unit, val) values ("'.$strHeureMesure.'","kwhr",'.$2.')';
			if (!($sqlins eq '')) {
				system('echo \''.$sqlins.'\' | mysql -u root --password=asnow06 conso_watt_et_temp');
				print $strHeureMesure." : ".$2."\n";
			}
		}
		# Historique Journalier
		while ($subdata =~ m!<d(\d+)>*(.+)</d\1>!g) {
			my $sqlins = "";
			my ($year,$month,$day, $hour,$min,$sec) = Add_Delta_YMDHMS(Today_and_Now(), 0,0,-$1,0,0,0);# on retranche la valeur de la balise XML c a s le nb de jour à la date actuelle
			my $strHeureMesure = sprintf("%4d-%02d-%02d %02d:%02d:%02d",$year,$month,$day,$hour,$min,$sec);
			#my $strHeureMesure = ($year+1900).'-'.($mon+1).'-'.$mday.' '.$hour.':'.$min.':'.$sec;
			$sqlins = 'insert into xmldataHJ (date, unit, val) values ("'.$strHeureMesure.'","kwhr",'.$2.')';
			if (!($sqlins eq '')) {
				system('echo \''.$sqlins.'\' | mysql -u root --password=asnow06 conso_watt_et_temp');
				print $strHeureMesure." : ".$2."\n";
			}
		}
		# Historique Mensuel
		while ($subdata =~ m!<m(\d+)>*(.+)</m\1>!g) {
			my $sqlins = "";
			my ($year,$month,$day, $hour,$min,$sec) = Add_Delta_YMDHMS(Today_and_Now(), 0,-$1,0,0,0,0);# on retranche la valeur de la balise XML c a s le nb de mois à la date actuelle
			my $strHeureMesure = sprintf("%4d-%02d-%02d %02d:%02d:%02d",$year,$month,$day,$hour,$min,$sec);
			#my $strHeureMesure = ($year+1900).'-'.($mon+1).'-'.$mday.' '.$hour.':'.$min.':'.$sec;
			$sqlins = 'insert into xmldataHM (date, unit, val) values ("'.$strHeureMesure.'","kwhr",'.$2.')';
			if (!($sqlins eq '')) {
				system('echo \''.$sqlins.'\' | mysql -u root --password=asnow06 conso_watt_et_temp');
				print $strHeureMesure." : ".$2."\n";
			}
		}
	}
}

#le =head et =cut sont des instructions servant pour les générateurs de documentation mais c'est il semblerait la seule alternative pour mettre rapidement un bloc de code en commentaire avec xCode.
# sinon il faudrait ajouter le # au début de chaque ligne, un peu fastidieu pour des dizaines de lignes lors du dev
=head

#my $historydata = "<msg><src>CC128-v0.11</src><dsb>00269</dsb><time>10:50:23</time><hist><dsw>00269</dsw><type>1</type><units>kwhr</units><data><sensor>0</sensor><h746>1.140</h746><h744>0.525</h744><h742>0.524</h742><h740>0.574</h740><h738>0.898</h738><h736>1.489</h736><h734>1.626</h734><h732>1.707</h732><h730>1.731</h730><h728>1.679</h728><h726>1.711</h726><h724>1.776</h724><h722>0.233</h722><h720>0.491</h720><h718>0.526</h718><h716>0.515</h716><h714>0.597</h714><h712>0.229</h712><h710>0.250</h710><h708>0.250</h708><h706>0.257</h706><h704>0.246</h704><h702>0.253</h702><h700>1.146</h700><h698>1.153</h698><h696>0.563</h696><h694>0.403</h694><h692>0.528</h692><h690>0.259</h690><h688>1.169</h688><h686>1.523</h686><h684>1.570</h684><h682>1.575</h682><h680>1.630</h680><h678>1.682</h678><h676>1.361</h676><h674>0.665</h674><h672>0.561</h672><h670>0.700</h670><h668>0.576</h668><h666>0.505</h666><h664>0.228</h664><h662>0.258</h662><h660>0.256</h660><h658>0.261</h658><h656>0.256</h656><h654>0.248</h654><h652>0.256</h652><h650>0.242</h650><h648>0.222</h648></data><data><sensor>1</sensor><h746>0.000</h746><h744>0.000</h744><h742>0.000</h742><h740>0.000</h740><h738>0.000</h738><h736>0.000</h736><h734>0.000</h734><h732>0.000</h732><h730>0.000</h730><h728>0.000</h728><h726>0.000</h726><h724>0.000</h724><h722>0.000</h722><h720>0.000</h720><h718>0.000</h718><h716>0.000</h716><h714>0.000</h714><h712>0.000</h712><h710>0.000</h710><h708>0.000</h708><h706>0.000</h706><h704>0.000</h704><h702>0.000</h702><h700>0.000</h700><h698>0.000</h698><h696>0.000</h696><h694>0.000</h694><h692>0.000</h692><h690>0.000</h690><h688>0.000</h688><h686>0.000</h686><h684>0.000</h684><h682>0.000</h682><h680>0.000</h680><h678>0.000</h678><h676>0.000</h676><h674>0.000</h674><h672>0.000</h672><h670>0.000</h670><h668>0.000</h668><h666>0.000</h666><h664>0.000</h664><h662>0.000</h662><h660>0.000</h660><h658>0.000</h658><h656>0.000</h656><h654>0.000</h654><h652>0.000</h652><h650>0.000</h650><h648>0.000</h648></data><data><sensor>2</sensor><h746>0.000</h746><h744>0.000</h744><h742>0.000</h742><h740>0.000</h740><h738>0.000</h738><h736>0.000</h736><h734>0.000</h734><h732>0.000</h732><h730>0.000</h730><h728>0.000</h728><h726>0.000</h726><h724>0.000</h724><h722>0.000</h722><h720>0.000</h720><h718>0.000</h718><h716>0.000</h716><h714>0.000</h714><h712>0.000</h712><h710>0.000</h710><h708>0.000</h708><h706>0.000</h706><h704>0.000</h704><h702>0.000</h702><h700>0.000</h700><h698>0.000</h698><h696>0.000</h696><h694>0.000</h694><h692>0.000</h692><h690>0.000</h690><h688>0.000</h688><h686>0.000</h686><h684>0.000</h684><h682>0.000</h682><h680>0.000</h680><h678>0.000</h678><h676>0.000</h676><h674>0.000</h674><h672>0.000</h672><h670>0.000</h670><h668>0.000</h668><h666>0.000</h666><h664>0.000</h664><h662>0.000</h662><h660>0.000</h660><h658>0.000</h658><h656>0.000</h656><h654>0.000</h654><h652>0.000</h652><h650>0.000</h650><h648>0.000</h648></data><data><sensor>3</sensor><h746>0.000</h746><h744>0.000</h744><h742>0.000</h742><h740>0.000</h740><h738>0.000</h738><h736>0.000</h736><h734>0.000</h734><h732>0.000</h732><h730>0.000</h730><h728>0.000</h728><h726>0.000</h726><h724>0.000</h724><h722>0.000</h722><h720>0.000</h720><h718>0.000</h718><h716>0.000</h716><h714>0.000</h714><h712>0.000</h712><h710>0.000</h710><h708>0.000</h708><h706>0.000</h706><h704>0.000</h704><h702>0.000</h702><h700>0.000</h700><h698>0.000</h698><h696>0.000</h696><h694>0.000</h694><h692>0.000</h692><h690>0.000</h690><h688>0.000</h688><h686>0.000</h686><h684>0.000</h684><h682>0.000</h682><h680>0.000</h680><h678>0.000</h678><h676>0.000</h676><h674>0.000</h674><h672>0.000</h672><h670>0.000</h670><h668>0.000</h668><h666>0.000</h666><h664>0.000</h664><h662>0.000</h662><h660>0.000</h660><h658>0.000</h658><h656>0.000</h656><h654>0.000</h654><h652>0.000</h652><h650>0.000</h650><h648>0.000</h648></data><data><sensor>4</sensor><h746>0.000</h746><h744>0.000</h744><h742>0.000</h742><h740>0.000</h740><h738>0.000</h738><h736>0.000</h736><h734>0.000</h734><h732>0.000</h732><h730>0.000</h730><h728>0.000</h728><h726>0.000</h726><h724>0.000</h724><h722>0.000</h722><h720>0.000</h720><h718>0.000</h718><h716>0.000</h716><h714>0.000</h714><h712>0.000</h712><h710>0.000</h710><h708>0.000</h708><h706>0.000</h706><h704>0.000</h704><h702>0.000</h702><h700>0.000</h700><h698>0.000</h698><h696>0.000</h696><h694>0.000</h694><h692>0.000</h692><h690>0.000</h690><h688>0.000</h688><h686>0.000</h686><h684>0.000</h684><h682>0.000</h682><h680>0.000</h680><h678>0.000</h678><h676>0.000</h676><h674>0.000</h674><h672>0.000</h672><h670>0.000</h670><h668>0.000</h668><h666>0.000</h666><h664>0.000</h664><h662>0.000</h662><h660>0.000</h660><h658>0.000</h658><h656>0.000</h656><h654>0.000</h654><h652>0.000</h652><h650>0.000</h650><h648>0.000</h648></data><data><sensor>5</sensor><h746>0.000</h746><h744>0.000</h744><h742>0.000</h742><h740>0.000</h740><h738>0.000</h738><h736>0.000</h736><h734>0.000</h734><h732>0.000</h732><h730>0.000</h730><h728>0.000</h728><h726>0.000</h726><h724>0.000</h724><h722>0.000</h722><h720>0.000</h720><h718>0.000</h718><h716>0.000</h716><h714>0.000</h714><h712>0.000</h712><h710>0.000</h710><h708>0.000</h708><h706>0.000</h706><h704>0.000</h704><h702>0.000</h702><h700>0.000</h700><h698>0.000</h698><h696>0.000</h696><h694>0.000</h694><h692>0.000</h692><h690>0.000</h690><h688>0.000</h688><h686>0.000</h686><h684>0.000</h684><h682>0.000</h682><h680>0.000</h680><h678>0.000</h678><h676>0.000</h676><h674>0.000</h674><h672>0.000</h672><h670>0.000</h670><h668>0.000</h668><h666>0.000</h666><h664>0.000</h664><h662>0.000</h662><h660>0.000</h660><h658>0.000</h658><h656>0.000</h656><h654>0.000</h654><h652>0.000</h652><h650>0.000</h650><h648>0.000</h648></data><data><sensor>6</sensor><h746>0.000</h746><h744>0.000</h744><h742>0.000</h742><h740>0.000</h740><h738>0.000</h738><h736>0.000</h736><h734>0.000</h734><h732>0.000</h732><h730>0.000</h730><h728>0.000</h728><h726>0.000</h726><h724>0.000</h724><h722>0.000</h722><h720>0.000</h720><h718>0.000</h718><h716>0.000</h716><h714>0.000</h714><h712>0.000</h712><h710>0.000</h710><h708>0.000</h708><h706>0.000</h706><h704>0.000</h704><h702>0.000</h702><h700>0.000</h700><h698>0.000</h698><h696>0.000</h696><h694>0.000</h694><h692>0.000</h692><h690>0.000</h690><h688>0.000</h688><h686>0.000</h686><h684>0.000</h684><h682>0.000</h682><h680>0.000</h680><h678>0.000</h678><h676>0.000</h676><h674>0.000</h674><h672>0.000</h672><h670>0.000</h670><h668>0.000</h668><h666>0.000</h666><h664>0.000</h664><h662>0.000</h662><h660>0.000</h660><h658>0.000</h658><h656>0.000</h656><h654>0.000</h654><h652>0.000</h652><h650>0.000</h650><h648>0.000</h648></data><data><sensor>7</sensor><h746>0.000</h746><h744>0.000</h744><h742>0.000</h742><h740>0.000</h740><h738>0.000</h738><h736>0.000</h736><h734>0.000</h734><h732>0.000</h732><h730>0.000</h730><h728>0.000</h728><h726>0.000</h726><h724>0.000</h724><h722>0.000</h722><h720>0.000</h720><h718>0.000</h718><h716>0.000</h716><h714>0.000</h714><h712>0.000</h712><h710>0.000</h710><h708>0.000</h708><h706>0.000</h706><h704>0.000</h704><h702>0.000</h702><h700>0.000</h700><h698>0.000</h698><h696>0.000</h696><h694>0.000</h694><h692>0.000</h692><h690>0.000</h690><h688>0.000</h688><h686>0.000</h686><h684>0.000</h684><h682>0.000</h682><h680>0.000</h680><h678>0.000</h678><h676>0.000</h676><h674>0.000</h674><h672>0.000</h672><h670>0.000</h670><h668>0.000</h668><h666>0.000</h666><h664>0.000</h664><h662>0.000</h662><h660>0.000</h660><h658>0.000</h658><h656>0.000</h656><h654>0.000</h654><h652>0.000</h652><h650>0.000</h650><h648>0.000</h648></data><data><sensor>8</sensor><h746>0.000</h746><h744>0.000</h744><h742>0.000</h742><h740>0.000</h740><h738>0.000</h738><h736>0.000</h736><h734>0.000</h734><h732>0.000</h732><h730>0.000</h730><h728>0.000</h728><h726>0.000</h726><h724>0.000</h724><h722>0.000</h722><h720>0.000</h720><h718>0.000</h718><h716>0.000</h716><h714>0.000</h714><h712>0.000</h712><h710>0.000</h710><h708>0.000</h708><h706>0.000</h706><h704>0.000</h704><h702>0.000</h702><h700>0.000</h700><h698>0.000</h698><h696>0.000</h696><h694>0.000</h694><h692>0.000</h692><h690>0.000</h690><h688>0.000</h688><h686>0.000</h686><h684>0.000</h684><h682>0.000</h682><h680>0.000</h680><h678>0.000</h678><h676>0.000</h676><h674>0.000</h674><h672>0.000</h672><h670>0.000</h670><h668>0.000</h668><h666>0.000</h666><h664>0.000</h664><h662>0.000</h662><h660>0.000</h660><h658>0.000</h658><h656>0.000</h656><h654>0.000</h654><h652>0.000</h652><h650>0.000</h650><h648>0.000</h648></data><data><sensor>9</sensor><h746>0.000</h746><h744>0.000</h744><h742>0.000</h742><h740>0.000</h740><h738>0.000</h738><h736>0.000</h736><h734>0.000</h734><h732>0.000</h732><h730>0.000</h730><h728>0.000</h728><h726>0.000</h726><h724>0.000</h724><h722>0.000</h722><h720>0.000</h720><h718>0.000</h718><h716>0.000</h716><h714>0.000</h714><h712>0.000</h712><h710>0.000</h710><h708>0.000</h708><h706>0.000</h706><h704>0.000</h704><h702>0.000</h702><h700>0.000</h700><h698>0.000</h698><h696>0.000</h696><h694>0.000</h694><h692>0.000</h692><h690>0.000</h690><h688>0.000</h688><h686>0.000</h686><h684>0.000</h684><h682>0.000</h682><h680>0.000</h680><h678>0.000</h678><h676>0.000</h676><h674>0.000</h674><h672>0.000</h672><h670>0.000</h670><h668>0.000</h668><h666>0.000</h666><h664>0.000</h664><h662>0.000</h662><h660>0.000</h660><h658>0.000</h658><h656>0.000</h656><h654>0.000</h654><h652>0.000</h652><h650>0.000</h650><h648>0.000</h648></data></hist></msg>";
my $historydata = "<msg><src>CC128-v0.11</src><dsb>00269</dsb><time>10:50:26</time><hist><dsw>00269</dsw><type>1</type><units>kwhr</units><data><sensor>0</sensor><h158>0.247</h158><h156>0.249</h156><h154>0.243</h154><h152>0.240</h152><h150>0.241</h150><h148>0.242</h148><h146>0.220</h146><h144>0.215</h144><h142>0.216</h142><h140>0.214</h140><h138>0.217</h138><h136>0.244</h136><h134>0.247</h134><h132>0.250</h132><h130>0.251</h130><h128>0.250</h128><h126>0.253</h126><h124>0.252</h124><h122>0.228</h122><h120>0.230</h120><h118>0.225</h118><h116>0.224</h116><h114>0.303</h114><h112>0.323</h112><h110>0.333</h110><h108>0.331</h108><h106>0.341</h106><h104>0.330</h104><h102>0.336</h102><h100>1.233</h100><h098>0.804</h098><h096>0.632</h096><h094>0.798</h094><h092>0.320</h092><h090>0.229</h090><h088>0.230</h088><h086>0.257</h086><h084>0.248</h084><h082>0.260</h082><h080>0.248</h080><h078>0.253</h078><h076>0.313</h076><h074>0.692</h074><h072>0.547</h072><h070>0.871</h070><h068>0.849</h068><h066>0.593</h066><h064>0.444</h064><h062>0.374</h062><h060>0.370</h060></data><data><sensor>1</sensor><h158>0.000</h158><h156>0.000</h156><h154>0.000</h154><h152>0.000</h152><h150>0.000</h150><h148>0.000</h148><h146>0.000</h146><h144>0.000</h144><h142>0.000</h142><h140>0.000</h140><h138>0.000</h138><h136>0.000</h136><h134>0.000</h134><h132>0.000</h132><h130>0.000</h130><h128>0.000</h128><h126>0.000</h126><h124>0.000</h124><h122>0.000</h122><h120>0.000</h120><h118>0.000</h118><h116>0.000</h116><h114>0.000</h114><h112>0.000</h112><h110>0.000</h110><h108>0.000</h108><h106>0.000</h106><h104>0.000</h104><h102>0.000</h102><h100>0.000</h100><h098>0.000</h098><h096>0.000</h096><h094>0.000</h094><h092>0.000</h092><h090>0.000</h090><h088>0.000</h088><h086>0.000</h086><h084>0.000</h084><h082>0.000</h082><h080>0.000</h080><h078>0.000</h078><h076>0.000</h076><h074>0.000</h074><h072>0.000</h072><h070>0.000</h070><h068>0.000</h068><h066>0.000</h066><h064>0.000</h064><h062>0.000</h062><h060>0.000</h060></data><data><sensor>2</sensor><h158>0.000</h158><h156>0.000</h156><h154>0.000</h154><h152>0.000</h152><h150>0.000</h150><h148>0.000</h148><h146>0.000</h146><h144>0.000</h144><h142>0.000</h142><h140>0.000</h140><h138>0.000</h138><h136>0.000</h136><h134>0.000</h134><h132>0.000</h132><h130>0.000</h130><h128>0.000</h128><h126>0.000</h126><h124>0.000</h124><h122>0.000</h122><h120>0.000</h120><h118>0.000</h118><h116>0.000</h116><h114>0.000</h114><h112>0.000</h112><h110>0.000</h110><h108>0.000</h108><h106>0.000</h106><h104>0.000</h104><h102>0.000</h102><h100>0.000</h100><h098>0.000</h098><h096>0.000</h096><h094>0.000</h094><h092>0.000</h092><h090>0.000</h090><h088>0.000</h088><h086>0.000</h086><h084>0.000</h084><h082>0.000</h082><h080>0.000</h080><h078>0.000</h078><h076>0.000</h076><h074>0.000</h074><h072>0.000</h072><h070>0.000</h070><h068>0.000</h068><h066>0.000</h066><h064>0.000</h064><h062>0.000</h062><h060>0.000</h060></data><data><sensor>3</sensor><h158>0.000</h158><h156>0.000</h156><h154>0.000</h154><h152>0.000</h152><h150>0.000</h150><h148>0.000</h148><h146>0.000</h146><h144>0.000</h144><h142>0.000</h142><h140>0.000</h140><h138>0.000</h138><h136>0.000</h136><h134>0.000</h134><h132>0.000</h132><h130>0.000</h130><h128>0.000</h128><h126>0.000</h126><h124>0.000</h124><h122>0.000</h122><h120>0.000</h120><h118>0.000</h118><h116>0.000</h116><h114>0.000</h114><h112>0.000</h112><h110>0.000</h110><h108>0.000</h108><h106>0.000</h106><h104>0.000</h104><h102>0.000</h102><h100>0.000</h100><h098>0.000</h098><h096>0.000</h096><h094>0.000</h094><h092>0.000</h092><h090>0.000</h090><h088>0.000</h088><h086>0.000</h086><h084>0.000</h084><h082>0.000</h082><h080>0.000</h080><h078>0.000</h078><h076>0.000</h076><h074>0.000</h074><h072>0.000</h072><h070>0.000</h070><h068>0.000</h068><h066>0.000</h066><h064>0.000</h064><h062>0.000</h062><h060>0.000</h060></data><data><sensor>4</sensor><h158>0.000</h158><h156>0.000</h156><h154>0.000</h154><h152>0.000</h152><h150>0.000</h150><h148>0.000</h148><h146>0.000</h146><h144>0.000</h144><h142>0.000</h142><h140>0.000</h140><h138>0.000</h138><h136>0.000</h136><h134>0.000</h134><h132>0.000</h132><h130>0.000</h130><h128>0.000</h128><h126>0.000</h126><h124>0.000</h124><h122>0.000</h122><h120>0.000</h120><h118>0.000</h118><h116>0.000</h116><h114>0.000</h114><h112>0.000</h112><h110>0.000</h110><h108>0.000</h108><h106>0.000</h106><h104>0.000</h104><h102>0.000</h102><h100>0.000</h100><h098>0.000</h098><h096>0.000</h096><h094>0.000</h094><h092>0.000</h092><h090>0.000</h090><h088>0.000</h088><h086>0.000</h086><h084>0.000</h084><h082>0.000</h082><h080>0.000</h080><h078>0.000</h078><h076>0.000</h076><h074>0.000</h074><h072>0.000</h072><h070>0.000</h070><h068>0.000</h068><h066>0.000</h066><h064>0.000</h064><h062>0.000</h062><h060>0.000</h060></data><data><sensor>5</sensor><h158>0.000</h158><h156>0.000</h156><h154>0.000</h154><h152>0.000</h152><h150>0.000</h150><h148>0.000</h148><h146>0.000</h146><h144>0.000</h144><h142>0.000</h142><h140>0.000</h140><h138>0.000</h138><h136>0.000</h136><h134>0.000</h134><h132>0.000</h132><h130>0.000</h130><h128>0.000</h128><h126>0.000</h126><h124>0.000</h124><h122>0.000</h122><h120>0.000</h120><h118>0.000</h118><h116>0.000</h116><h114>0.000</h114><h112>0.000</h112><h110>0.000</h110><h108>0.000</h108><h106>0.000</h106><h104>0.000</h104><h102>0.000</h102><h100>0.000</h100><h098>0.000</h098><h096>0.000</h096><h094>0.000</h094><h092>0.000</h092><h090>0.000</h090><h088>0.000</h088><h086>0.000</h086><h084>0.000</h084><h082>0.000</h082><h080>0.000</h080><h078>0.000</h078><h076>0.000</h076><h074>0.000</h074><h072>0.000</h072><h070>0.000</h070><h068>0.000</h068><h066>0.000</h066><h064>0.000</h064><h062>0.000</h062><h060>0.000</h060></data><data><sensor>6</sensor><h158>0.000</h158><h156>0.000</h156><h154>0.000</h154><h152>0.000</h152><h150>0.000</h150><h148>0.000</h148><h146>0.000</h146><h144>0.000</h144><h142>0.000</h142><h140>0.000</h140><h138>0.000</h138><h136>0.000</h136><h134>0.000</h134><h132>0.000</h132><h130>0.000</h130><h128>0.000</h128><h126>0.000</h126><h124>0.000</h124><h122>0.000</h122><h120>0.000</h120><h118>0.000</h118><h116>0.000</h116><h114>0.000</h114><h112>0.000</h112><h110>0.000</h110><h108>0.000</h108><h106>0.000</h106><h104>0.000</h104><h102>0.000</h102><h100>0.000</h100><h098>0.000</h098><h096>0.000</h096><h094>0.000</h094><h092>0.000</h092><h090>0.000</h090><h088>0.000</h088><h086>0.000</h086><h084>0.000</h084><h082>0.000</h082><h080>0.000</h080><h078>0.000</h078><h076>0.000</h076><h074>0.000</h074><h072>0.000</h072><h070>0.000</h070><h068>0.000</h068><h066>0.000</h066><h064>0.000</h064><h062>0.000</h062><h060>0.000</h060></data><data><sensor>7</sensor><h158>0.000</h158><h156>0.000</h156><h154>0.000</h154><h152>0.000</h152><h150>0.000</h150><h148>0.000</h148><h146>0.000</h146><h144>0.000</h144><h142>0.000</h142><h140>0.000</h140><h138>0.000</h138><h136>0.000</h136><h134>0.000</h134><h132>0.000</h132><h130>0.000</h130><h128>0.000</h128><h126>0.000</h126><h124>0.000</h124><h122>0.000</h122><h120>0.000</h120><h118>0.000</h118><h116>0.000</h116><h114>0.000</h114><h112>0.000</h112><h110>0.000</h110><h108>0.000</h108><h106>0.000</h106><h104>0.000</h104><h102>0.000</h102><h100>0.000</h100><h098>0.000</h098><h096>0.000</h096><h094>0.000</h094><h092>0.000</h092><h090>0.000</h090><h088>0.000</h088><h086>0.000</h086><h084>0.000</h084><h082>0.000</h082><h080>0.000</h080><h078>0.000</h078><h076>0.000</h076><h074>0.000</h074><h072>0.000</h072><h070>0.000</h070><h068>0.000</h068><h066>0.000</h066><h064>0.000</h064><h062>0.000</h062><h060>0.000</h060></data><data><sensor>8</sensor><h158>0.000</h158><h156>0.000</h156><h154>0.000</h154><h152>0.000</h152><h150>0.000</h150><h148>0.000</h148><h146>0.000</h146><h144>0.000</h144><h142>0.000</h142><h140>0.000</h140><h138>0.000</h138><h136>0.000</h136><h134>0.000</h134><h132>0.000</h132><h130>0.000</h130><h128>0.000</h128><h126>0.000</h126><h124>0.000</h124><h122>0.000</h122><h120>0.000</h120><h118>0.000</h118><h116>0.000</h116><h114>0.000</h114><h112>0.000</h112><h110>0.000</h110><h108>0.000</h108><h106>0.000</h106><h104>0.000</h104><h102>0.000</h102><h100>0.000</h100><h098>0.000</h098><h096>0.000</h096><h094>0.000</h094><h092>0.000</h092><h090>0.000</h090><h088>0.000</h088><h086>0.000</h086><h084>0.000</h084><h082>0.000</h082><h080>0.000</h080><h078>0.000</h078><h076>0.000</h076><h074>0.000</h074><h072>0.000</h072><h070>0.000</h070><h068>0.000</h068><h066>0.000</h066><h064>0.000</h064><h062>0.000</h062><h060>0.000</h060></data><data><sensor>9</sensor><h158>0.000</h158><h156>0.000</h156><h154>0.000</h154><h152>0.000</h152><h150>0.000</h150><h148>0.000</h148><h146>0.000</h146><h144>0.000</h144><h142>0.000</h142><h140>0.000</h140><h138>0.000</h138><h136>0.000</h136><h134>0.000</h134><h132>0.000</h132><h130>0.000</h130><h128>0.000</h128><h126>0.000</h126><h124>0.000</h124><h122>0.000</h122><h120>0.000</h120><h118>0.000</h118><h116>0.000</h116><h114>0.000</h114><h112>0.000</h112><h110>0.000</h110><h108>0.000</h108><h106>0.000</h106><h104>0.000</h104><h102>0.000</h102><h100>0.000</h100><h098>0.000</h098><h096>0.000</h096><h094>0.000</h094><h092>0.000</h092><h090>0.000</h090><h088>0.000</h088><h086>0.000</h086><h084>0.000</h084><h082>0.000</h082><h080>0.000</h080><h078>0.000</h078><h076>0.000</h076><h074>0.000</h074><h072>0.000</h072><h070>0.000</h070><h068>0.000</h068><h066>0.000</h066><h064>0.000</h064><h062>0.000</h062><h060>0.000</h060></data></hist></msg>";
while ($historydata =~ m!<data><sensor>0</sensor>*(.+)</data><data><sensor>1</sensor>!g) {
	print $1."\n\n";
	my $subdata = $1;
	# Historique Horaire
	while ($subdata =~ m!<h(\d+)>*(.+)</h\1>!g) {
		my $sqlins = "";
		my ($year,$month,$day, $hour,$min,$sec) = Add_Delta_YMDHMS(Today_and_Now(), 0,0,0,-$1,0,0);# on retranche la valeur de la balise XML c a s le nb d'heure à la date actuelle
		my $strHeureMesure = sprintf("%4d-%02d-%02d %02d:%02d:%02d",$year,$month,$day,$hour,$min,$sec);
		#my $strHeureMesure = ($year+1900).'-'.($mon+1).'-'.$mday.' '.$hour.':'.$min.':'.$sec;
		$sqlins = 'insert into xmldataHH (date, unit, val) values ("'.$strHeureMesure.'","kwhr",'.$2.')';
		if (!($sqlins eq '')) {
			system('echo \''.$sqlins.'\' | mysql -u root --password=asnow06 conso_watt_et_temp');
			print $strHeureMesure." : ".$1." -> ".$2."\n";
		}
	}
	# Historique Journalier
	while ($subdata =~ m!<d(\d+)>*(.+)</d\1>!g) {
		my $sqlins = "";
		my ($year,$month,$day, $hour,$min,$sec) = Add_Delta_YMDHMS(Today_and_Now(), 0,0,-$1,0,0,0);# on retranche la valeur de la balise XML c a s le nb de jour à la date actuelle
		my $strHeureMesure = sprintf("%4d-%02d-%02d %02d:%02d:%02d",$year,$month,$day,$hour,$min,$sec);
		#my $strHeureMesure = ($year+1900).'-'.($mon+1).'-'.$mday.' '.$hour.':'.$min.':'.$sec;
		$sqlins = 'insert into xmldataHJ (date, unit, val) values ("'.$strHeureMesure.'","kwhr",'.$2.')';
		if (!($sqlins eq '')) {
			system('echo \''.$sqlins.'\' | mysql -u root --password=asnow06 conso_watt_et_temp');
			print $strHeureMesure." : ".$2."\n";
		}
	}
	# Historique Mensuel
	while ($subdata =~ m!<m(\d+)>*(.+)</m\1>!g) {
		my $sqlins = "";
		my ($year,$month,$day, $hour,$min,$sec) = Add_Delta_YMDHMS(Today_and_Now(), 0,-$1,0,0,0,0);# on retranche la valeur de la balise XML c a s le nb de mois à la date actuelle
		my $strHeureMesure = sprintf("%4d-%02d-%02d %02d:%02d:%02d",$year,$month,$day,$hour,$min,$sec);
		#my $strHeureMesure = ($year+1900).'-'.($mon+1).'-'.$mday.' '.$hour.':'.$min.':'.$sec;
		$sqlins = 'insert into xmldataHM (date, unit, val) values ("'.$strHeureMesure.'","kwhr",'.$2.')';
		if (!($sqlins eq '')) {
			system('echo \''.$sqlins.'\' | mysql -u root --password=asnow06 conso_watt_et_temp');
			print $strHeureMesure." : ".$2."\n";
		}
	}
}
=cut